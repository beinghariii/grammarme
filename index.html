<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Gemini Grammar Checker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4F46E5', // Indigo-600
                        'secondary': '#10B981', // Emerald-500
                        'background-dark': '#1F2937', // Gray-800
                        'surface-card': '#374151', // Gray-700
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #1F2937;
            color: #F3F4F6;
            min-height: 100vh;
        }
        .container-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        textarea {
            resize: vertical;
            min-height: 200px;
        }
        .loading-dots div {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots .dot-2 { animation-delay: -0.32s; }
        .loading-dots .dot-3 { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="font-sans p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-primary">Gemini Style & Grammar Pro</h1>
            <p class="mt-2 text-gray-300">Context-Aware Correction: Casual vs. Formal Modes</p>
        </header>

        <!-- Main Checker Interface -->
        <div class="bg-surface-card p-6 md:p-8 rounded-xl container-shadow">

            <!-- Input Area -->
            <h2 class="text-xl font-semibold mb-3 text-secondary">1. Enter Your Text</h2>
            <textarea id="inputText" class="w-full p-4 bg-gray-800 border border-gray-600 rounded-lg focus:ring-primary focus:border-primary placeholder-gray-400 text-white" placeholder="Write your paragraph, email draft, or casual message here..." rows="6"></textarea>

            <!-- Mode Selection -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3 text-secondary">2. Select Correction Mode</h2>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-6">
                    <label class="flex items-center space-x-2 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-150">
                        <input type="radio" name="mode" value="casual" checked class="form-radio text-primary ring-primary" id="modeCasual">
                        <span class="text-white font-medium">Casual Conversation</span>
                        <span class="text-xs text-gray-400 ml-2">(Natural flow, friendly tone, fixing core errors)</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-150">
                        <input type="radio" name="mode" value="formal" class="form-radio text-primary ring-primary" id="modeFormal">
                        <span class="text-white font-medium">Formal/Academic</span>
                        <span class="text-xs text-gray-400 ml-2">(Professional, precise language, no contractions/slang)</span>
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <button id="checkButton" class="w-full mt-6 py-3 px-4 bg-primary text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-300 transform active:scale-95 disabled:bg-gray-500 disabled:cursor-not-allowed">
                Check Grammar and Style
            </button>
        </div>

        <!-- Result Section -->
        <div id="resultContainer" class="mt-8 hidden">
            <div class="bg-surface-card p-6 md:p-8 rounded-xl container-shadow">
                <h2 class="text-2xl font-bold mb-4 text-primary">3. Results & Analysis</h2>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="hidden text-center py-10">
                    <div class="loading-dots flex justify-center space-x-2">
                        <div class="dot-1 w-3 h-3 bg-secondary rounded-full"></div>
                        <div class="dot-2 w-3 h-3 bg-secondary rounded-full"></div>
                        <div class="dot-3 w-3 h-3 bg-secondary rounded-full"></div>
                    </div>
                    <p class="mt-4 text-gray-400">Analyzing structure and tone...</p>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="hidden bg-red-800/20 text-red-300 p-4 rounded-lg border border-red-600 mb-4">
                    <p class="font-semibold">Error:</p>
                    <p id="errorText"></p>
                </div>

                <!-- Corrected Text -->
                <div id="correctedTextSection" class="mb-6">
                    <h3 class="text-xl font-semibold mb-2 text-secondary">Corrected Text</h3>
                    <div id="correctedTextOutput" class="p-4 bg-gray-800 border border-gray-600 rounded-lg whitespace-pre-wrap text-lg leading-relaxed text-gray-100"></div>
                </div>

                <!-- Explanation -->
                <div id="explanationSection">
                    <h3 class="text-xl font-semibold mb-2 text-secondary">Explanation of Changes</h3>
                    <div id="explanationOutput" class="p-4 bg-gray-800 border border-gray-600 rounded-lg text-sm text-gray-300"></div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Powered by Gemini. No user data is stored.</p>
        </footer>
    </div>

    <script type="text/javascript">
        // --- API Configuration ---
        const API_KEY = ""; // Leave empty. The environment will handle the key.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- DOM Elements ---
        const inputText = document.getElementById('inputText');
        const checkButton = document.getElementById('checkButton');
        const resultContainer = document.getElementById('resultContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const correctedTextOutput = document.getElementById('correctedTextOutput');
        const explanationOutput = document.getElementById('explanationOutput');

        // --- Helper Function: Exponential Backoff Retry ---
        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    // console.log(`Attempt ${retries + 1} failed. Retrying in ${delay.toFixed(0)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw new Error("Failed to connect to the API after multiple retries.");
            }
        }

        // --- Main Logic ---
        checkButton.addEventListener('click', handleGrammarCheck);

        async function handleGrammarCheck() {
            const text = inputText.value.trim();
            const mode = document.querySelector('input[name="mode"]:checked').value;

            if (text.length === 0) {
                displayError("Please enter some text to check.");
                return;
            }
            if (text.length < 10) {
                displayError("Please enter at least 10 characters for a meaningful check.");
                return;
            }

            // Reset UI
            resultContainer.classList.remove('hidden');
            correctedTextOutput.textContent = '';
            explanationOutput.innerHTML = '';
            errorMessage.classList.add('hidden');
            checkButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                const jsonResponse = await generateCorrection(text, mode);
                displayResults(jsonResponse);
            } catch (error) {
                displayError(error.message);
            } finally {
                checkButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        function getSystemInstruction(mode) {
            const toneInstruction = mode === 'casual'
                ? "make it sound natural, friendly, and appropriate for a casual conversation, while fixing all grammar and spelling errors. Maintain a warm, conversational tone."
                : "focus on clarity, precision, professional vocabulary, and formal grammar rules suitable for an academic or business document. Eliminate all slang, contractions, and colloquialisms.";

            return `You are an advanced, context-aware grammar and style checker. Your task is to revise and correct the provided text. The user has selected the '${mode}' mode. You MUST ${toneInstruction}. Return the response in a structured JSON format.`;
        }

        function getUserQuery(text) {
            return `Analyze and revise the following text according to the specified style: "${text}"`;
        }

        async function generateCorrection(text, mode) {
            const systemPrompt = getSystemInstruction(mode);
            const userQuery = getUserQuery(text);

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "correctedText": { "type": "STRING", "description": "The fully corrected and revised text based on the selected mode." },
                            "explanation": { "type": "STRING", "description": "A detailed, structured explanation of the changes made, addressing grammar, spelling, and style/tone adjustments. Format this explanation with bullet points or numbered lists using Markdown." }
                        },
                        required: ["correctedText", "explanation"]
                    }
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithRetry(API_URL, options);
            const result = await response.json();

            // Check for API errors or empty response
            if (!result.candidates || result.candidates.length === 0) {
                throw new Error(result.error?.message || "Received an empty response from the API.");
            }

            const jsonString = result.candidates[0].content.parts[0].text;
            let data;
            try {
                data = JSON.parse(jsonString);
            } catch (e) {
                // If parsing fails, the model might have returned text instead of JSON.
                console.error("Failed to parse JSON:", jsonString, e);
                throw new Error("The checker returned an unexpected format. Please try again.");
            }

            // Ensure the expected keys are present
            if (!data.correctedText || !data.explanation) {
                throw new Error("The API response was structured, but missing the corrected text or explanation fields.");
            }

            return data;
        }

        function displayResults(data) {
            correctedTextOutput.textContent = data.correctedText;
            // Simple markdown-like processing for the explanation for better readability
            explanationOutput.innerHTML = data.explanation
                .split('\n')
                .map(line => {
                    // Convert markdown list items (-, *, 1., etc.) into proper HTML list items
                    if (line.trim().match(/^(\*|\-|\d+\.)\s/)) {
                        return `<li class="ml-4 list-disc text-sm">${line.replace(/^(\*|\-|\d+\.)\s*/, '')}</li>`;
                    }
                    // Handle headers (like ##) if they accidentally appear
                    if (line.trim().startsWith('##')) {
                        return `<p class="mt-3 mb-1 font-semibold text-white">${line.replace(/##\s*/, '')}</p>`;
                    }
                    // Treat as a regular paragraph
                    return `<p class="mb-2">${line}</p>`;
                })
                .join('');
        }

        function displayError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
        }

        // Initial setup for the placeholder text to guide the user
        window.onload = () => {
             inputText.value = "I need to get they're data by tomorrow but I aint sure where they put it.";
        };

    </script>
</body>
</html>
